name: ğŸš€ GitHub Action Release Pipeline

# ğŸ¯ Triggers
# - Push to master/main branches (excluding docs)
# - Manual dispatch with release options
on:
  push:
    branches: [master, main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'ğŸ“Œ Override version (e.g., 1.2.3, leave empty for auto-detection)'
        required: false
        type: string
        default: ''
      force-release:
        description: 'ğŸ”„ Force release even if no changes'
        required: false
        default: false
        type: boolean

# Global permissions for the workflow
permissions:
  contents: write
  actions: read
  pull-requests: read

env:
  # ğŸŒ Global Configuration
  RELEASE_AUTHOR: "github-actions[bot]"
  RELEASE_EMAIL: "github-actions[bot]@users.noreply.github.com"
  UBUNTU_VERSION: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB 1: QUALITY GATE - Security, Structure & Code Quality
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• 
  quality-gate:
    name: ğŸ” Quality Gate
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    outputs:
      quality-success: ${{ steps.evaluate.outputs.quality-success }}
      action-name: ${{ steps.discover-action.outputs.action-name }}
      action-type: ${{ steps.discover-action.outputs.action-type }}
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Discover Action Metadata
        id: discover-action
        shell: pwsh
        run: |
          & "./.github/scripts/Discover-ActionName.ps1"

      - name: ğŸ” GitLeaks Security Scan
        uses: zricethezav/gitleaks-action@v2.3.9
        continue-on-error: true
        id: gitleaks

      - name: ğŸ“‹ Validate Action Structure
        id: validate-structure
        shell: pwsh
        run: |
          & "./.github/scripts/Test-ActionStructure.ps1"

      - name: ğŸ¨ Lint PowerShell Scripts
        id: lint
        shell: pwsh
        run: |
          & "./.github/scripts/Invoke-ScriptAnalyzer.ps1"

      - name: ğŸ“Š Evaluate Quality Gate
        id: evaluate
        shell: pwsh
        run: |
          & "./.github/scripts/Invoke-QualityGateEvaluation.ps1" `
            -GitLeaksOutcome '${{ steps.gitleaks.outcome }}' `
            -StructureSuccess '${{ steps.validate-structure.outputs.structure-success }}' `
            -SchemaSuccess '${{ steps.validate-structure.outputs.schema-success }}' `
            -LintSuccess '${{ steps.lint.outputs.analysis-success }}' `
            -ActionName '${{ steps.discover-action.outputs.action-name }}' `
            -ActionType '${{ steps.discover-action.outputs.action-type }}' `
            -ScriptsAnalyzed '${{ steps.lint.outputs.scripts-analyzed }}' `
            -TotalErrors '${{ steps.lint.outputs.total-errors }}' `
            -TotalWarnings '${{ steps.lint.outputs.total-warnings }}'

      - name: ğŸ“‹ Quality Gate Summary
        if: always()
        shell: pwsh
        run: |
          $gitleaksOk = '${{ steps.gitleaks.outcome }}' -eq 'success'
          $structureOk = '${{ steps.validate-structure.outputs.structure-success }}' -eq 'true'
          $schemaOk = '${{ steps.validate-structure.outputs.schema-success }}' -eq 'true'
          $lintOk = '${{ steps.lint.outputs.analysis-success }}' -eq 'true'
          $qualityOk = '${{ steps.evaluate.outputs.quality-success }}' -eq 'true'
          
          $actionName = '${{ steps.discover-action.outputs.action-name }}'
          $actionType = '${{ steps.discover-action.outputs.action-type }}'
          $scriptsAnalyzed = [int]'${{ steps.lint.outputs.scripts-analyzed }}'
          $totalErrors = '${{ steps.lint.outputs.total-errors }}'
          $totalWarnings = '${{ steps.lint.outputs.total-warnings }}'
          
          $overallStatus = if ($qualityOk) { 'âœ… **PASSED**' } else { 'âŒ **FAILED**' }
          
          # Linting result with warning for 0 scripts
          $lintResult = if ($lintOk) { 'âœ… Passed' } else { 'âš ï¸ Issues' }
          $lintDetails = "$scriptsAnalyzed scripts, $totalErrors errors"
          
          $summary = @"
          <details>
          <summary>ğŸ” Quality Gate Results - $overallStatus</summary>
          
          | Check | Result | Details |
          |-------|--------|---------|
          | **ğŸ”’ Security** | $(if ($gitleaksOk) { 'âœ… Passed' } else { 'âš ï¸ Issues' }) | GitLeaks secret scanning |
          | **ğŸ“‹ Structure** | $(if ($structureOk) { 'âœ… Passed' } else { 'âŒ Failed' }) | action.yml validation |
          | **ğŸ“ Schema** | $(if ($schemaOk) { 'âœ… Passed' } else { 'âš ï¸ Skipped' }) | Action schema check |
          | **ğŸ¨ Linting** | $lintResult | $lintDetails |
          
          "@
          
          # Add warning block if 0 scripts analyzed
          if ($scriptsAnalyzed -eq 0) {
            $summary += @"
          
          > âš ï¸ **Note:** 0 scripts analyzed. This is valid if PowerShell code is embedded in ``action.yml`` (composite action).
          > Excluded from discovery: ``.git/``, ``.github/scripts/``
          
          "@
          }
          
          $summary += @"
          
          ### ğŸ¯ Action Details
          | Property | Value |
          |----------|-------|
          | **Name** | ``$actionName`` |
          | **Type** | ``$actionType`` |
          | **Warnings** | ``$totalWarnings`` |
          | **Overall** | $overallStatus |
          
          </details>
          
          ---
          "@
          
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“¦ JOB 2: PREPARE RELEASE - Version Detection
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare-release:
    name: ğŸ“¦ Prepare Release
    needs: quality-gate
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && 
      needs.quality-gate.outputs.quality-success == 'true'
    outputs:
      new-version: ${{ steps.determine-version.outputs.final-version }}
      should-release: ${{ steps.determine-version.outputs.should-release }}
      bump-type: ${{ steps.determine-version.outputs.bump-type }}
      current-version: ${{ steps.version.outputs.currentVersion }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â¬†ï¸ Analyze next version
        id: version
        uses: GrexyLoco/K.Actions.NextActionVersion@master
        with:
          branchName: ${{ github.ref_name }}

      - name: ğŸ”¢ Determine final version
        id: determine-version
        shell: pwsh
        run: |
          & "./.github/scripts/Determine-Version.ps1" `
            -ManualVersion '${{ github.event.inputs.version }}' `
            -AutoBumpType '${{ steps.version.outputs.bumpType }}' `
            -AutoNewVersion '${{ steps.version.outputs.newVersion }}' `
            -ForceRelease '${{ github.event.inputs.force-release }}'

      - name: ğŸ“‹ Prepare Release Summary
        if: always()
        shell: pwsh
        run: |
          $shouldRelease = '${{ steps.determine-version.outputs.should-release }}'
          $version = '${{ steps.determine-version.outputs.final-version }}'
          $bumpType = '${{ steps.determine-version.outputs.bump-type }}'
          $currentVersion = '${{ steps.version.outputs.currentVersion }}'
          
          $statusIcon = if ($shouldRelease -eq 'true') { 'âœ… Ready' } else { 'â„¹ï¸ No Release' }
          $headerStatus = if ($shouldRelease -eq 'true') { 'âœ… Ready for Release' } else { 'â„¹ï¸ No Release Required' }
          
          $summary = @"
          <details>
          <summary>ğŸ“¦ Prepare Release - $headerStatus</summary>
          
          | Property | Value |
          |----------|-------|
          | **Current Version** | ``$currentVersion`` |
          | **New Version** | ``$version`` |
          | **Bump Type** | ``$bumpType`` |
          | **Status** | $statusIcon |
          
          "@
          
          if ($shouldRelease -ne 'true') {
            $summary += @"
          
          > â„¹ï¸ **No Release Required**
          > No semantic version changes detected since last tag.
          > Use manual workflow dispatch with ``force-release`` to create a release anyway.
          
          "@
          }
          
          $summary += @"
          
          </details>
          
          ---
          "@
          
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ JOB 3: GITHUB RELEASE - Tag, Smart Tags, Release
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  github-release:
    name: ğŸš€ GitHub Release
    needs: [quality-gate, prepare-release]
    if: needs.prepare-release.outputs.should-release == 'true'
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    outputs:
      release-created: ${{ steps.create-release.outputs.release-created }}
      release-tag: ${{ steps.create-release.outputs.release-tag }}
      release-url: ${{ steps.create-release.outputs.release-url }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸš€ Create Complete Release (Draft â†’ Smart Tags â†’ Publish)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Create GitHub Release
        id: create-release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          & "./.github/scripts/Create-GitHubRelease.ps1" `
            -Version '${{ needs.prepare-release.outputs.new-version }}' `
            -BumpType '${{ needs.prepare-release.outputs.bump-type }}' `
            -ActionName '${{ needs.quality-gate.outputs.action-name }}' `
            -Repository '${{ github.repository }}'

      - name: ğŸ“‹ Release Summary
        if: always()
        shell: pwsh
        run: |
          $version = '${{ needs.prepare-release.outputs.new-version }}'
          $releaseUrl = '${{ steps.create-release.outputs.release-url }}'
          $releaseCreated = '${{ steps.create-release.outputs.release-created }}'
          $tagsCreated = '${{ steps.create-release.outputs.tags-created }}'
          $actionName = '${{ needs.quality-gate.outputs.action-name }}'
          $repository = '${{ github.repository }}'
          
          $statusIcon = if ($releaseCreated -eq 'true') { 'âœ… Published' } else { 'âŒ Failed' }
          $headerStatus = if ($releaseCreated -eq 'true') { 'âœ… Published' } else { 'âŒ Failed' }
          $majorVersion = $version.Split('.')[0]
          $minorVersion = "$($version.Split('.')[0]).$($version.Split('.')[1])"
          
          # Parse tags created
          $tagsList = if ($tagsCreated) { $tagsCreated -split ',' } else { @("v$version", "v$majorVersion", "v$minorVersion", 'latest') }
          $tagsDisplay = ($tagsList | ForEach-Object { "``$_``" }) -join ', '
          
          $summary = @"
          <details open>
          <summary>ğŸš€ GitHub Release - $headerStatus</summary>
          
          | Property | Value |
          |----------|-------|
          | **Version** | ``v$version`` |
          | **Release Tag** | ``v$version`` |
          | **Status** | $statusIcon |
          | **Release** | [$releaseUrl]($releaseUrl) |
          
          ### ğŸ·ï¸ Tags Created/Updated
          
          | Tag | Target | Description |
          |-----|--------|-------------|
          | ``v$version`` | HEAD | ğŸ“Œ Pinned version (immutable) |
          | ``v$minorVersion`` | â†’ ``v$version`` | ğŸ”„ Minor version (moves with patches) |
          | ``v$majorVersion`` | â†’ ``v$version`` | ğŸ”„ Major version (moves with minor/patches) |
          | ``latest`` | â†’ ``v$version`` | ğŸ”„ Always points to newest release |
          
          ### ğŸ“– Usage Example
          
          ``````yaml
          - name: $actionName
            uses: $repository@v$version
            with:
              # Add your inputs here
          ``````
          
          ### ğŸ”— Quick Reference
          
          | Reference | Usage | Description |
          |-----------|-------|-------------|
          | **Latest** | ``$repository@latest`` | Always newest version |
          | **Pinned** | ``$repository@v$version`` | Exact version |
          | **Major** | ``$repository@v$majorVersion`` | Auto-update within major |
          
          </details>
          
          ---
          **ğŸ‰ Release pipeline complete!**
          "@
          
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY
