name: ğŸš€ Action Release Pipeline

# Global permissions for the workflow
permissions:
  contents: write    # Required for creating releases and updating README
  actions: read      # Required to read workflow status
  pull-requests: read # Required for reading PR information

on:
  # Automatic trigger on push to main/master branches
  push:
    branches: [ master, main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  # Manual trigger for action releases
  workflow_dispatch:
    inputs:
      release-type:
        description: 'Type of release'
        required: true
        default: 'patch'
        type: choice
        options:
        - 'patch'
        - 'minor'
        - 'major'
      force-release:
        description: 'Force release even if no changes'
        required: false
        default: false
        type: boolean

env:
  RELEASE_AUTHOR: "github-actions[bot]"
  RELEASE_EMAIL: "github-actions[bot]@users.noreply.github.com"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB 1: QUALITY GATE - Security, Structure & Code Quality
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality-gate:
    name: ğŸ” Quality Gate
    uses: ./.github/workflows/release_action_test.yml
    with:
      test-scope: 'full'
    permissions:
      contents: write
      actions: read
      pull-requests: read
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“¦ JOB 2: PREPARE RELEASE - Version Detection & Changelog
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare-release:
    name: ğŸ“¦ Prepare Release
    needs: quality-gate
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && (needs.quality-gate.outputs.test-success == 'true' || github.event.inputs.force-release == 'true')
    outputs:
      new-version: ${{ steps.version.outputs.newVersion }}
      current-version: ${{ steps.version.outputs.currentVersion }}
      bump-type: ${{ steps.version.outputs.bumpType }}
      should-release: ${{ steps.release-check.outputs.skip-release != 'true' }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â¬†ï¸ Analyze next version
        id: version
        uses: GrexyLoco/K.Actions.NextActionVersion@master
        with:
          branchName: ${{ github.ref_name }}

      - name: ğŸ” Check if release needed
        id: release-check
        shell: pwsh
        run: |
          $bumpType = '${{ steps.version.outputs.bumpType }}'
          $forceRelease = '${{ github.event.inputs.force-release }}'
          
          Write-Output "ğŸ” Release Analysis:"
          Write-Output "  Current Version: ${{ steps.version.outputs.currentVersion }}"
          Write-Output "  New Version: ${{ steps.version.outputs.newVersion }}"
          Write-Output "  Bump Type: $bumpType"
          Write-Output "  Force Release: $forceRelease"
          
          if ($bumpType -eq 'none' -and $forceRelease -ne 'true') {
            Write-Output "â­ï¸ No version changes detected - skipping release"
            "skip-release=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            Write-Output "âœ… Release will be created"
            "skip-release=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          }

      - name: ğŸ“ Generate Changelog
        id: changelog
        if: steps.release-check.outputs.skip-release != 'true'
        shell: pwsh
        run: |
          Write-Output "ğŸ“ Generating changelog..."
          
          $version = '${{ steps.version.outputs.newVersion }}'
          $latestTag = git describe --tags --abbrev=0 2>$null
          
          if ($latestTag) {
              $commits = git log --pretty=format:"- %s" "$latestTag..HEAD"
          } else {
              $commits = git log --pretty=format:"- %s" | Select-Object -First 10
          }
          
          # Create changelog
          $changelogLines = @()
          $changelogLines += "## What's Changed in $version"
          $changelogLines += ""
          $changelogLines += "### ğŸš€ Features & Improvements"
          if ($commits) {
              $changelogLines += $commits
          } else {
              $changelogLines += "- Initial release"
          }
          $changelogLines += ""
          $changelogLines += "### ğŸ›¡ï¸ Action Capabilities"
          $changelogLines += "- **Security Scanning**: GitLeaks"
          $changelogLines += "- **PowerShell Linting**: PSScriptAnalyzer"
          $changelogLines += "- **Structure Validation**: action.yml schema checks"
          $changelogLines += "- **Enterprise Ready**: Fully parametrized for reuse"
          $changelogLines += ""
          $changelogLines += "### ğŸ“‹ Usage"
          $changelogLines += '```yaml'
          $changelogLines += "- name: Validate PowerShell Module"
          $changelogLines += "  uses: GrexyLoco/K.Actions.PSModuleValidation@$version"
          $changelogLines += "  with:"
          $changelogLines += '    github-token: ${{ secrets.GITHUB_TOKEN }}'
          $changelogLines += "    module-name: 'YourModule'"
          $changelogLines += '```'
          if ($latestTag) {
              $changelogLines += ""
              $changelogLines += "**Full Changelog**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation/compare/$latestTag...$version"
          }
          
          $changelog = $changelogLines -join "`n"
          
          "changelog<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          $changelog | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ JOB 3: GITHUB RELEASE - Tag, Release, Publish
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  github-release:
    name: ğŸš€ GitHub Release
    needs: [quality-gate, prepare-release]
    if: needs.prepare-release.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    outputs:
      release-created: ${{ steps.create-release.outputs.release-created }}
      release-tag: ${{ steps.create-release.outputs.release-tag }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Create Release Tag
        shell: pwsh
        run: |
          $version = '${{ needs.prepare-release.outputs.new-version }}'
          
          git config user.name "${{ env.RELEASE_AUTHOR }}"
          git config user.email "${{ env.RELEASE_EMAIL }}"
          
          git tag -a $version -m "ğŸš€ Release $version

          Automated release of K.Actions.PSModuleValidation
          
          Features:
          - Comprehensive PowerShell module validation
          - Security scanning with GitLeaks
          - PSScriptAnalyzer linting
          - Action structure validation
          - Enterprise-ready parametrization"
          
          git push origin $version
          
          Write-Output "âœ… Tag created: $version"

      - name: ğŸ“¦ Create GitHub Release
        id: create-release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = '${{ needs.prepare-release.outputs.new-version }}'
          $changelog = @'
          ${{ needs.prepare-release.outputs.changelog }}
          '@
          
          gh release create $version --title "ğŸš€ K.Actions.PSModuleValidation $version" --notes "$changelog"
          
          "release-created=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "release-tag=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          Write-Output "âœ… Release created: $version"

      - name: ğŸ“‹ Generate Release Summary
        shell: pwsh
        run: |
          $version = '${{ needs.prepare-release.outputs.new-version }}'
          $testSuccess = '${{ needs.quality-gate.outputs.test-success }}'
          
          $summary = @"
          ## ğŸš€ Release Complete - $version
          
          ### ğŸ“Š Release Status
          **Version:** $version
          **Tests:** $(if ($testSuccess -eq 'true') { 'âœ… PASSED' } else { 'âŒ FAILED' })
          **Status:** âœ… RELEASED
          
          ### ğŸ¯ Action Features
          - ğŸ” **Security Scanning** - GitLeaks
          - ğŸ¨ **Code Quality** - PSScriptAnalyzer
          - ğŸ“‹ **Structure Validation** - action.yml checks
          - âš™ï¸ **Configurable** - Enterprise-ready parameters
          
          ### ğŸ“‹ Usage Instructions
          \`\`\`yaml
          uses: GrexyLoco/K.Actions.PSModuleValidation@$version
          \`\`\`
          
          ### ğŸ”— Links
          - **Repository**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation
          - **Release**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation/releases/tag/$version
          - **Documentation**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation#readme
          
          ---
          **Action is ready for production use! ğŸ‰**
          "@
          
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          ## â­ï¸ No Release Required
          
          ### ğŸ“Š Analysis Results
          **Current Version:** $currentVersion
          **Bump Type:** $bumpType
          **Status:** âœ… NO CHANGES DETECTED
          
          ### ğŸ” Why No Release?
          - No semantic version changes since last tag
          - Use manual trigger with force-release to override
          
          ### ğŸ§ª Test Results
          **Tests:** $(if ($testSuccess -eq 'true') { 'âœ… PASSED' } else { 'âŒ FAILED' })
          
          ### ğŸ“‹ Next Steps
          - Make commits with conventional format (\`feat:\`, \`fix:\`, \`BREAKING CHANGE:\`)
          - Or use manual workflow dispatch with force-release option
          
          ---
          **Repository is up-to-date! ğŸ‰**
          "@
          } else {
            $summary = @"
          ## ğŸš€ Release Complete - $version
          
          ### ğŸ“Š Release Status
          **Version:** $version
          **Tests:** $(if ($testSuccess -eq 'true') { 'âœ… PASSED' } else { 'âŒ FAILED' })
          **Status:** $(if ($testSuccess -eq 'true') { 'âœ… RELEASED' } else { 'âŒ BLOCKED' })
          
          ### ğŸ¯ Action Features
          - ğŸ›¡ï¸ **Security Scanning** - GitLeaks & Super-Linter
          - ğŸ§ª **PowerShell Testing** - Pester v5 with coverage
          - ğŸ“Š **Rich Reporting** - Enhanced GitHub summaries
          - âš™ï¸ **Configurable** - Enterprise-ready parameters
          
          ### ğŸ“‹ Usage Instructions
          \`\`\`yaml
          uses: GrexyLoco/K.Actions.PSModuleValidation@$version
          \`\`\`
          
          ### ğŸ”— Links
          - **Repository**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation
          - **Release**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation/releases/tag/$version
          - **Documentation**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation#readme
          
          ---
          **Action is ready for production use across all PowerShell modules! ğŸ‰**
          "@
          }
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ–ï¸ JOB 4: UPDATE BADGES (Optional, Action-specific)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-badges:
    name: ğŸ–ï¸ Update Success Badges
    runs-on: ubuntu-latest
    needs: [quality-gate, github-release]
    if: success() && needs.github-release.outputs.release-created == 'true'
    permissions:
      contents: write
      actions: read
      
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: ğŸ–ï¸ Generate Success Badges
        id: create-badges
        shell: pwsh
        run: |
          Write-Output "ğŸ–ï¸ Generating success badges after successful release..."
          
          $testsBadge = "![Tests](https://img.shields.io/badge/Tests-passing-green)"
          $securityBadge = "![Security](https://img.shields.io/badge/Security-passing-green)"
          $lintingBadge = "![Linting](https://img.shields.io/badge/Linting-passing-green)"
          $crossPlatformBadge = "![Cross-Platform](https://img.shields.io/badge/Cross--Platform-passing-green)"
          
          $ubuntuBadge = "![Ubuntu](https://img.shields.io/badge/Ubuntu_22.04-compatible-green)"
          $windowsBadge = "![Windows](https://img.shields.io/badge/Windows_2022-compatible-green)"
          
          "tests-badge=$testsBadge" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "security-badge=$securityBadge" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "linting-badge=$lintingBadge" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "cross-platform-badge=$crossPlatformBadge" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "ubuntu-badge=$ubuntuBadge" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "windows-badge=$windowsBadge" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          Write-Output "âœ… Success badges generated!"

      - name: ğŸ“ Update README with Badges
        id: update-readme
        shell: pwsh
        run: |
          Write-Output "ğŸ“ Updating README.md with success badges..."
          
          $testsBadge = '${{ steps.create-badges.outputs.tests-badge }}'
          $securityBadge = '${{ steps.create-badges.outputs.security-badge }}'
          $lintingBadge = '${{ steps.create-badges.outputs.linting-badge }}'
          $crossPlatformBadge = '${{ steps.create-badges.outputs.cross-platform-badge }}'
          $ubuntuBadge = '${{ steps.create-badges.outputs.ubuntu-badge }}'
          $windowsBadge = '${{ steps.create-badges.outputs.windows-badge }}'
          
          $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'
          $version = '${{ needs.prepare-release.outputs.new-version }}'
          
          $badgeSection = @"
          <!-- AUTO-GENERATED TEST BADGES - DO NOT EDIT MANUALLY -->
          ## ğŸ§ª Current Test Status
          
          $testsBadge $securityBadge $lintingBadge $crossPlatformBadge
          
          ### Platform Compatibility
          $ubuntuBadge $windowsBadge
          
          > ğŸ“Š **Status**: passing | **Updated**: $timestamp | **Version**: $version | **Auto-generated**
          <!-- END AUTO-GENERATED TEST BADGES -->
          "@
          
          # Read and update README
          $readmePath = './README.md'
          
          if (-not (Test-Path $readmePath)) {
              Write-Output "âš ï¸ README.md not found - skipping badge update"
              exit 0
          }
          
          $readmeContent = Get-Content $readmePath -Raw
          
          # Replace badge section
          $badgeStartPattern = '<!-- AUTO-GENERATED TEST BADGES - DO NOT EDIT MANUALLY -->'
          $badgeEndPattern = '<!-- END AUTO-GENERATED TEST BADGES -->'
          
          if ($readmeContent -match "(?s)$([regex]::Escape($badgeStartPattern)).*?$([regex]::Escape($badgeEndPattern))") {
              $updatedContent = $readmeContent -replace "(?s)$([regex]::Escape($badgeStartPattern)).*?$([regex]::Escape($badgeEndPattern))", $badgeSection
              Write-Output "âœ… Updated existing badge section"
          } else {
              # Add new section after license badge
              if ($readmeContent -match '(\[!\[License\].*?\]\(LICENSE\))(\r?\n)') {
                  $insertionPoint = $matches[0]
                  $updatedContent = $readmeContent -replace [regex]::Escape($insertionPoint), "$insertionPoint`n`n$badgeSection`n"
                  Write-Output "âœ… Added new badge section"
              } else {
                  Write-Output "âš ï¸ Could not find insertion point for badges - skipping"
                  exit 0
              }
          }
          
          $updatedContent | Out-File $readmePath -Encoding UTF8 -NoNewline
          "badges-updated=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: ğŸ’¾ Commit Badge Updates
        if: steps.update-readme.outputs.badges-updated == 'true'
        shell: pwsh
        run: |
          git config --local user.email "${{ env.RELEASE_EMAIL }}"
          git config --local user.name "${{ env.RELEASE_AUTHOR }}"
          
          git add README.md
          $version = '${{ needs.prepare-release.outputs.new-version }}'
          
          git commit -m "ğŸ–ï¸ Update badges after release $version

          All tests passed and release $version was successfully created!
          
          [skip ci]"
          
          git push
          
          Write-Output "âœ… Badges updated and committed!"
