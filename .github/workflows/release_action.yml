name: ğŸš€ Action Release Pipeline

# Global permissions for the workflow
permissions:
  contents: write    # Required for creating releases and updating README
  actions: read      # Required to read workflow status
  pull-requests: read # Required for reading PR information

on:
  # Automatic trigger on push to main/master branches
  push:
    branches: [ master, main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  # Manual trigger for action releases
  workflow_dispatch:
    inputs:
      release-type:
        description: 'Type of release'
        required: true
        default: 'patch'
        type: choice
        options:
        - 'patch'
        - 'minor'
        - 'major'
      force-release:
        description: 'Force release even if no changes'
        required: false
        default: false
        type: boolean

env:
  RELEASE_AUTHOR: "github-actions[bot]"
  RELEASE_EMAIL: "github-actions[bot]@users.noreply.github.com"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB 1: QUALITY GATE - Security, Structure & Code Quality
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality-gate:
    name: ğŸ” Quality Gate
    runs-on: ubuntu-latest
    outputs:
      quality-success: ${{ steps.evaluate.outputs.quality-success }}
      action-name: ${{ steps.validate-structure.outputs.action-name }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” GitLeaks Security Scan
        uses: zricethezav/gitleaks-action@v2.3.9
        continue-on-error: true
        id: gitleaks

      - name: ğŸ“‹ Validate Action Structure
        id: validate-structure
        shell: pwsh
        run: ./.github/scripts/Test-ActionStructure.ps1

      - name: ğŸ¨ Lint PowerShell Scripts
        id: lint
        shell: pwsh
        run: ./.github/scripts/Invoke-ScriptAnalyzer.ps1

      - name: ğŸ“Š Evaluate Quality Gate
        id: evaluate
        shell: pwsh
        run: |
          ./.github/scripts/Invoke-QualityGateEvaluation.ps1 `
            -GitLeaksOutcome '${{ steps.gitleaks.outcome }}' `
            -StructureSuccess '${{ steps.validate-structure.outputs.structure-success }}' `
            -SchemaSuccess '${{ steps.validate-structure.outputs.schema-success }}' `
            -LintSuccess '${{ steps.lint.outputs.analysis-success }}' `
            -ActionName '${{ steps.validate-structure.outputs.action-name }}' `
            -ActionType '${{ steps.validate-structure.outputs.action-type }}' `
            -ScriptsAnalyzed '${{ steps.lint.outputs.scripts-analyzed }}' `
            -TotalErrors '${{ steps.lint.outputs.total-errors }}' `
            -TotalWarnings '${{ steps.lint.outputs.total-warnings }}'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“¦ JOB 2: PREPARE RELEASE - Version Detection & Changelog
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare-release:
    name: ğŸ“¦ Prepare Release
    needs: quality-gate
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && needs.quality-gate.outputs.quality-success == 'true'
    outputs:
      new-version: ${{ steps.determine-version.outputs.final-version }}
      should-release: ${{ steps.determine-version.outputs.should-release }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â¬†ï¸ Analyze next version
        id: version
        uses: GrexyLoco/K.Actions.NextActionVersion@master
        with:
          branchName: ${{ github.ref_name }}

      - name: ğŸ”¢ Determine final version
        id: determine-version
        shell: pwsh
        run: |
          ./.github/scripts/Determine-ReleaseVersion.ps1 `
            -AutoBumpType '${{ steps.version.outputs.bumpType }}' `
            -AutoNewVersion '${{ steps.version.outputs.newVersion }}' `
            -ForceRelease '${{ github.event.inputs.force-release }}'

      - name: ğŸ“ Generate Changelog
        id: changelog
        if: steps.determine-version.outputs.should-release == 'true'
        shell: pwsh
        run: ./.github/scripts/Generate-Changelog.ps1 -Version '${{ steps.determine-version.outputs.final-version }}'

      - name: ğŸ“‹ Create Release Summary
        if: always()
        shell: pwsh
        run: |
          $shouldRelease = '${{ steps.determine-version.outputs.should-release }}'
          $version = '${{ steps.determine-version.outputs.final-version }}'
          $bumpType = '${{ steps.determine-version.outputs.bump-type }}'
          
          $summary = "## ğŸ“¦ Prepare Release`n`n"
          
          if ($shouldRelease -eq 'true') {
              $summary += "### âœ… Release Ready`n`n"
              $summary += "| Detail | Value |`n"
              $summary += "|--------|-------|`n"
              $summary += "| **Version** | ``$version`` |`n"
              $summary += "| **Bump Type** | ``$bumpType`` |`n"
              $summary += "| **Status** | Ready for GitHub Release |`n"
          } else {
              $summary += "### â„¹ï¸ No Release Required`n`n"
              $summary += "No semantic version changes detected since last tag.`n"
              $summary += "Use manual workflow dispatch with force-release to create a release anyway.`n"
          }
          
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ JOB 3: GITHUB RELEASE - Tag, Release, Publish
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  github-release:
    name: ğŸš€ GitHub Release
    needs: [quality-gate, prepare-release]
    if: needs.prepare-release.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    outputs:
      release-created: ${{ steps.create-release.outputs.release-created }}
      release-tag: ${{ steps.create-release.outputs.release-tag }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Create Release Tag
        shell: pwsh
        run: |
          ./.github/scripts/Create-ReleaseTag.ps1 `
            -Version '${{ needs.prepare-release.outputs.new-version }}' `
            -ReleaseAuthor '${{ env.RELEASE_AUTHOR }}' `
            -ReleaseEmail '${{ env.RELEASE_EMAIL }}'

      - name: ğŸ“¦ Create GitHub Release
        id: create-release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $changelog = @'
          ${{ needs.prepare-release.outputs.changelog }}
          '@
          
          ./.github/scripts/Create-GitHubRelease.ps1 `
            -Version '${{ needs.prepare-release.outputs.new-version }}' `
            -Changelog $changelog

      - name: ğŸ“‹ Generate Release Summary
        shell: pwsh
        run: ./.github/scripts/New-ReleaseSummary.ps1 -Version '${{ needs.prepare-release.outputs.new-version }}'
