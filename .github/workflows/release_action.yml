name: ðŸš€ Action Release Pipeline

# Global permissions for the workflow
permissions:
  contents: write    # Required for creating releases and updating README
  actions: read      # Required to read workflow status
  pull-requests: read # Required for reading PR information

on:
  # Automatic trigger on push to main/master branches
  push:
    branches: [ master, main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  # Manual trigger for action releases
  workflow_dispatch:
    inputs:
      release-type:
        description: 'Type of release'
        required: true
        default: 'patch'
        type: choice
        options:
        - 'patch'
        - 'minor'
        - 'major'
      force-release:
        description: 'Force release even if no changes'
        required: false
        default: false
        type: boolean

env:
  RELEASE_AUTHOR: "github-actions[bot]"
  RELEASE_EMAIL: "github-actions[bot]@users.noreply.github.com"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ” JOB 1: QUALITY GATE - Security, Structure & Code Quality
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality-gate:
    name: ðŸ” Quality Gate
    runs-on: ubuntu-latest
    outputs:
      quality-success: ${{ steps.evaluate.outputs.quality-success }}
      action-name: ${{ steps.validate-structure.outputs.action-name }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” GitLeaks Security Scan
        uses: zricethezav/gitleaks-action@v2.3.9
        continue-on-error: true
        id: gitleaks

      - name: ðŸ“‹ Validate Action Structure
        id: validate-structure
        shell: pwsh
        run: ./.github/scripts/Test-ActionStructure.ps1

      - name: ðŸŽ¨ Lint PowerShell Scripts
        id: lint
        shell: pwsh
        run: ./.github/scripts/Invoke-ScriptAnalyzer.ps1 -RootPath

      - name: ðŸ“Š Evaluate Quality Gate
        id: evaluate
        shell: pwsh
        run: |
          $gitleaks = '${{ steps.gitleaks.outcome }}'
          $structure = '${{ steps.validate-structure.outputs.structure-success }}'
          $schema = '${{ steps.validate-structure.outputs.schema-success }}'
          $lint = '${{ steps.lint.outputs.analysis-success }}'
          
          Write-Output "ðŸ” Quality Gate Results:"
          Write-Output "  ðŸ” GitLeaks: $gitleaks"
          Write-Output "  ðŸ“‹ Structure: $structure"
          Write-Output "  ðŸ“‹ Schema: $schema"
          Write-Output "  ðŸŽ¨ Linting: $lint"
          
          $success = ($gitleaks -ne 'failure') -and ($structure -eq 'True') -and ($schema -eq 'True') -and ($lint -eq 'True')
          
          "quality-success=$success" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          if ($success) {
              Write-Output "âœ… Quality Gate passed!"
          } else {
              Write-Output "âŒ Quality Gate failed!"
              exit 1
          }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“¦ JOB 2: PREPARE RELEASE - Version Detection & Changelog
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare-release:
    name: ðŸ“¦ Prepare Release
    needs: quality-gate
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && needs.quality-gate.outputs.quality-success == 'true'
    outputs:
      new-version: ${{ steps.determine-version.outputs.final-version }}
      should-release: ${{ steps.determine-version.outputs.should-release }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â¬†ï¸ Analyze next version
        id: version
        uses: GrexyLoco/K.Actions.NextActionVersion@master
        with:
          branchName: ${{ github.ref_name }}

      - name: ðŸ”¢ Determine final version
        id: determine-version
        shell: pwsh
        run: |
          ./.github/scripts/Determine-ReleaseVersion.ps1 `
            -AutoBumpType '${{ steps.version.outputs.bumpType }}' `
            -AutoNewVersion '${{ steps.version.outputs.newVersion }}' `
            -ForceRelease '${{ github.event.inputs.force-release }}'

      - name: ðŸ“ Generate Changelog
        id: changelog
        if: steps.determine-version.outputs.should-release == 'true'
        shell: pwsh
        run: ./.github/scripts/Generate-Changelog.ps1 -Version '${{ steps.determine-version.outputs.final-version }}'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸš€ JOB 3: GITHUB RELEASE - Tag, Release, Publish
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  github-release:
    name: ðŸš€ GitHub Release
    needs: [quality-gate, prepare-release]
    if: needs.prepare-release.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    outputs:
      release-created: ${{ steps.create-release.outputs.release-created }}
      release-tag: ${{ steps.create-release.outputs.release-tag }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Create Release Tag
        shell: pwsh
        run: |
          ./.github/scripts/Create-ReleaseTag.ps1 `
            -Version '${{ needs.prepare-release.outputs.new-version }}' `
            -ReleaseAuthor '${{ env.RELEASE_AUTHOR }}' `
            -ReleaseEmail '${{ env.RELEASE_EMAIL }}'

      - name: ðŸ“¦ Create GitHub Release
        id: create-release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $changelog = @'
          ${{ needs.prepare-release.outputs.changelog }}
          '@
          
          ./.github/scripts/Create-GitHubRelease.ps1 `
            -Version '${{ needs.prepare-release.outputs.new-version }}' `
            -Changelog $changelog

      - name: ðŸ“‹ Generate Release Summary
        shell: pwsh
        run: |
          $version = '${{ needs.prepare-release.outputs.new-version }}'
          
          $summary = @"
          ## ðŸš€ Release Complete - $version
          
          ### ðŸ“Š Release Status
          **Version:** $version
          **Quality Gate:** âœ… PASSED
          **Status:** âœ… RELEASED
          
          ### ðŸŽ¯ Action Features
          - ðŸ” **Security Scanning** - GitLeaks
          - ðŸŽ¨ **Code Quality** - PSScriptAnalyzer
          - ðŸ“‹ **Structure Validation** - action.yml checks
          - âš™ï¸ **Configurable** - Enterprise-ready parameters
          
          ### ðŸ“‹ Usage Instructions
          \`\`\`yaml
          uses: GrexyLoco/K.Actions.PSModuleValidation@$version
          \`\`\`
          
          ### ðŸ”— Links
          - **Repository**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation
          - **Release**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation/releases/tag/$version
          - **Documentation**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation#readme
          
          ---
          **Action is ready for production use! ðŸŽ‰**
          "@
          
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          ## â­ï¸ No Release Required
          
          ### ðŸ“Š Analysis Results
          **Current Version:** $currentVersion
          **Bump Type:** $bumpType
          **Status:** âœ… NO CHANGES DETECTED
          
          ### ðŸ” Why No Release?
          - No semantic version changes since last tag
          - Use manual trigger with force-release to override
          
          ### ðŸ§ª Test Results
          **Tests:** $(if ($testSuccess -eq 'true') { 'âœ… PASSED' } else { 'âŒ FAILED' })
          
          ### ðŸ“‹ Next Steps
          - Make commits with conventional format (\`feat:\`, \`fix:\`, \`BREAKING CHANGE:\`)
          - Or use manual workflow dispatch with force-release option
          
          ---
          **Repository is up-to-date! ðŸŽ‰**
          "@
          } else {
            $summary = @"
          ## ðŸš€ Release Complete - $version
          
          ### ðŸ“Š Release Status
          **Version:** $version
          **Tests:** $(if ($testSuccess -eq 'true') { 'âœ… PASSED' } else { 'âŒ FAILED' })
          **Status:** $(if ($testSuccess -eq 'true') { 'âœ… RELEASED' } else { 'âŒ BLOCKED' })
          
          ### ðŸŽ¯ Action Features
          - ðŸ›¡ï¸ **Security Scanning** - GitLeaks & Super-Linter
          - ðŸ§ª **PowerShell Testing** - Pester v5 with coverage
          - ðŸ“Š **Rich Reporting** - Enhanced GitHub summaries
          - âš™ï¸ **Configurable** - Enterprise-ready parameters
          
          ### ðŸ“‹ Usage Instructions
          \`\`\`yaml
          uses: GrexyLoco/K.Actions.PSModuleValidation@$version
          \`\`\`
          
          ### ðŸ”— Links
          - **Repository**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation
          - **Release**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation/releases/tag/$version
          - **Documentation**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation#readme
          
          ---
          **Action is ready for production use across all PowerShell modules! ðŸŽ‰**
          "@
          }
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY
