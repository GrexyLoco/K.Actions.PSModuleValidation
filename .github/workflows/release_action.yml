name: ðŸš€ Action Release Pipeline

# Global permissions for the workflow
permissions:
  contents: write    # Required for creating releases and updating README
  actions: read      # Required to read workflow status
  pull-requests: read # Required for reading PR information

on:
  # Automatic trigger on push to main/master branches
  push:
    branches: [ master, main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  # Manual trigger for action releases
  workflow_dispatch:
    inputs:
      release-type:
        description: 'Type of release'
        required: true
        default: 'patch'
        type: choice
        options:
        - 'patch'
        - 'minor'
        - 'major'
      force-release:
        description: 'Force release even if no changes'
        required: false
        default: false
        type: boolean
      test-scope:
        description: 'Scope of tests to run before release'
        required: false
        default: 'full'
        type: choice
        options:
        - 'full'
        - 'security-only'
        - 'integration-only'
        - 'cross-platform-only'

jobs:
  # ðŸ§ª First run ALL tests - Release ONLY if tests pass!
  run-tests:
    name: ðŸ§ª Run Action Release Tests
    uses: ./.github/workflows/release_action_test.yml
    with:
      test-scope: ${{ inputs.test-scope || 'full' }}
    permissions:
      contents: write  # Required for badge updates to README
      actions: read    # Required to read workflow status
      pull-requests: read  # Required for PR information
    secrets: inherit  # Pass all secrets to the reusable workflow
    
  # ðŸ“¦ Release job depends on successful tests
  create-release:
    name: ðŸ“¦ Create Release
    runs-on: ubuntu-latest
    needs: run-tests
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && (needs.run-tests.outputs.test-success == 'true' || github.event.inputs.force-release == 'true')
    outputs:
      version: ${{ steps.version.outputs.newVersion }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â¬†ï¸ Analyze next version
        id: version
        uses: GrexyLoco/K.Actions.NextActionVersion@master
        with:
          branchName: ${{ github.ref_name }}

      - name: ðŸ” Check if release needed
        id: release-check
        shell: pwsh
        run: |
          $bumpType = '${{ steps.version.outputs.bumpType }}'
          $forceRelease = '${{ github.event.inputs.force-release }}'
          
          Write-Host "ðŸ” Release Analysis:" -ForegroundColor Cyan
          Write-Host "  Current Version: ${{ steps.version.outputs.currentVersion }}" -ForegroundColor White
          Write-Host "  New Version: ${{ steps.version.outputs.newVersion }}" -ForegroundColor White
          Write-Host "  Bump Type: $bumpType" -ForegroundColor White
          Write-Host "  Force Release: $forceRelease" -ForegroundColor White
          
          if ($bumpType -eq 'none' -and $forceRelease -ne 'true') {
            Write-Host "â­ï¸ No version changes detected - skipping release" -ForegroundColor Yellow
            Write-Output "skip-release=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âœ… Release will be created" -ForegroundColor Green
            Write-Output "skip-release=false" >> $env:GITHUB_OUTPUT
          }

      - name: ðŸ“ Generate Changelog
        id: changelog
        if: steps.release-check.outputs.skip-release != 'true'
        shell: pwsh
        run: |
          Write-Host "ðŸ“ Generating changelog..." -ForegroundColor Cyan
          
          $version = '${{ steps.version.outputs.newVersion }}'
          $latestTag = git describe --tags --abbrev=0 2>$null
          
          if ($latestTag) {
              $commits = git log --pretty=format:"- %s" "$latestTag..HEAD"
          } else {
              $commits = git log --pretty=format:"- %s"
          }
          
          $changelog = @"
          ## What's Changed in $version
          
          ### ðŸš€ Features & Improvements
          $($commits -join "`n")
          
          ### ðŸ›¡ï¸ Action Capabilities
          - **Security Scanning**: GitLeaks + Super-Linter
          - **PowerShell Testing**: Pester v5 with code coverage
          - **Enhanced Reporting**: Rich GitHub step summaries
          - **Enterprise Ready**: Fully parametrized for reuse
          
          ### ðŸ“‹ Usage
          \`\`\`yaml
          - name: Validate PowerShell Module
            uses: GrexyLoco/K.Actions.PSModuleValidation@$version
            with:
              github-token: \${{ secrets.GITHUB_TOKEN }}
              module-name: 'YourModule'
          \`\`\`
          
          **Full Changelog**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation/compare/$latestTag...$version
          "@
          
          # Escape for GitHub output
          $changelog = $changelog -replace '"','\"' -replace '\r?\n','%0A'
          Write-Output "changelog=$changelog" >> $env:GITHUB_OUTPUT

      - name: ðŸ·ï¸ Create Release Tag
        if: steps.release-check.outputs.skip-release != 'true'
        shell: pwsh
        run: |
          $version = '${{ steps.version.outputs.newVersion }}'
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a $version -m "ðŸš€ Release $version

          Automated release of K.Actions.PSModuleValidation
          
          Features:
          - Comprehensive PowerShell module validation
          - Security scanning with GitLeaks and Super-Linter  
          - Pester v5 testing with code coverage
          - Enhanced GitHub step summaries
          - Enterprise-ready parametrization"
          
          git push origin $version

      - name: ðŸ“¦ Create GitHub Release
        if: steps.release-check.outputs.skip-release != 'true'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = '${{ steps.version.outputs.newVersion }}'
          $changelog = '${{ steps.changelog.outputs.changelog }}'
          
          # Create release using GitHub CLI
          gh release create $version --title "ðŸš€ K.Actions.PSModuleValidation $version" --notes "$changelog"

      - name: ðŸ“‹ Generate Release Summary
        if: always()
        shell: pwsh
        run: |
          $version = '${{ steps.version.outputs.newVersion }}'
          $currentVersion = '${{ steps.version.outputs.currentVersion }}'
          $bumpType = '${{ steps.version.outputs.bumpType }}'
          $skipRelease = '${{ steps.release-check.outputs.skip-release }}'
          $testSuccess = '${{ needs.run-tests.outputs.test-success }}'
          
          if ($skipRelease -eq 'true') {
            $summary = @"
          ## â­ï¸ No Release Required
          
          ### ðŸ“Š Analysis Results
          **Current Version:** $currentVersion
          **Bump Type:** $bumpType
          **Status:** âœ… NO CHANGES DETECTED
          
          ### ðŸ” Why No Release?
          - No semantic version changes since last tag
          - Use manual trigger with force-release to override
          
          ### ðŸ§ª Test Results
          **Tests:** $(if ($testSuccess -eq 'true') { 'âœ… PASSED' } else { 'âŒ FAILED' })
          
          ### ðŸ“‹ Next Steps
          - Make commits with conventional format (\`feat:\`, \`fix:\`, \`BREAKING CHANGE:\`)
          - Or use manual workflow dispatch with force-release option
          
          ---
          **Repository is up-to-date! ðŸŽ‰**
          "@
          } else {
            $summary = @"
          ## ðŸš€ Release Complete - $version
          
          ### ðŸ“Š Release Status
          **Version:** $version
          **Tests:** $(if ($testSuccess -eq 'true') { 'âœ… PASSED' } else { 'âŒ FAILED' })
          **Status:** $(if ($testSuccess -eq 'true') { 'âœ… RELEASED' } else { 'âŒ BLOCKED' })
          
          ### ðŸŽ¯ Action Features
          - ðŸ›¡ï¸ **Security Scanning** - GitLeaks & Super-Linter
          - ðŸ§ª **PowerShell Testing** - Pester v5 with coverage
          - ðŸ“Š **Rich Reporting** - Enhanced GitHub summaries
          - âš™ï¸ **Configurable** - Enterprise-ready parameters
          
          ### ðŸ“‹ Usage Instructions
          \`\`\`yaml
          uses: GrexyLoco/K.Actions.PSModuleValidation@$version
          \`\`\`
          
          ### ðŸ”— Links
          - **Repository**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation
          - **Release**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation/releases/tag/$version
          - **Documentation**: https://github.com/GrexyLoco/K.Actions.PSModuleValidation#readme
          
          ---
          **Action is ready for production use across all PowerShell modules! ðŸŽ‰**
          "@
          }
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY
