name: ðŸš€ Action Release Pipeline

# ðŸŽ¯ Triggers
# - Push to master/main branches (excluding docs)
# - Manual dispatch with release options
on:
  push:
    branches: [master, main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'ðŸ“Œ Override version (e.g., 1.2.3, leave empty for auto-detection)'
        required: false
        type: string
        default: ''
      force-release:
        description: 'ðŸ”„ Force release even if no changes'
        required: false
        default: false
        type: boolean

# Global permissions for the workflow
permissions:
  contents: write
  actions: read
  pull-requests: read

env:
  RELEASE_AUTHOR: "github-actions[bot]"
  RELEASE_EMAIL: "github-actions[bot]@users.noreply.github.com"
  UBUNTU_VERSION: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
  ACTION_NAME: "K.Actions.PSModuleValidation"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ” JOB 1: QUALITY GATE - Security, Structure & Code Quality
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality-gate:
    name: ðŸ” Quality Gate
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    outputs:
      quality-success: ${{ steps.evaluate.outputs.quality-success }}
      action-name: ${{ steps.validate-structure.outputs.action-name }}
      action-type: ${{ steps.validate-structure.outputs.action-type }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” GitLeaks Security Scan
        uses: zricethezav/gitleaks-action@v2.3.9
        continue-on-error: true
        id: gitleaks

      - name: ðŸ“‹ Validate Action Structure
        id: validate-structure
        shell: pwsh
        run: ./.github/scripts/Test-ActionStructure.ps1

      - name: ðŸŽ¨ Lint PowerShell Scripts
        id: lint
        shell: pwsh
        run: ./.github/scripts/Invoke-ScriptAnalyzer.ps1

      - name: ðŸ“Š Evaluate Quality Gate
        id: evaluate
        shell: pwsh
        run: |
          ./.github/scripts/Invoke-QualityGateEvaluation.ps1 `
            -GitLeaksOutcome '${{ steps.gitleaks.outcome }}' `
            -StructureSuccess '${{ steps.validate-structure.outputs.structure-success }}' `
            -SchemaSuccess '${{ steps.validate-structure.outputs.schema-success }}' `
            -LintSuccess '${{ steps.lint.outputs.analysis-success }}' `
            -ActionName '${{ steps.validate-structure.outputs.action-name }}' `
            -ActionType '${{ steps.validate-structure.outputs.action-type }}' `
            -ScriptsAnalyzed '${{ steps.lint.outputs.scripts-analyzed }}' `
            -TotalErrors '${{ steps.lint.outputs.total-errors }}' `
            -TotalWarnings '${{ steps.lint.outputs.total-warnings }}'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ“Š Quality Gate Summary
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“‹ Quality Gate Summary
        if: always()
        shell: pwsh
        run: |
          $gitleaksOk = '${{ steps.gitleaks.outcome }}' -eq 'success'
          $structureOk = '${{ steps.validate-structure.outputs.structure-success }}' -eq 'true'
          $schemaOk = '${{ steps.validate-structure.outputs.schema-success }}' -eq 'true'
          $lintOk = '${{ steps.lint.outputs.analysis-success }}' -eq 'true'
          $qualityOk = '${{ steps.evaluate.outputs.quality-success }}' -eq 'true'
          
          $actionName = '${{ steps.validate-structure.outputs.action-name }}'
          $actionType = '${{ steps.validate-structure.outputs.action-type }}'
          $scriptsAnalyzed = '${{ steps.lint.outputs.scripts-analyzed }}'
          $totalErrors = '${{ steps.lint.outputs.total-errors }}'
          $totalWarnings = '${{ steps.lint.outputs.total-warnings }}'
          
          $overallStatus = if ($qualityOk) { 'âœ… **PASSED**' } else { 'âŒ **FAILED**' }
          
          $summary = @"
          ## ðŸ” Quality Gate Results
          
          | Check | Result | Details |
          |-------|--------|---------|
          | **ðŸ”’ Security** | $(if ($gitleaksOk) { 'âœ… Passed' } else { 'âš ï¸ Issues' }) | GitLeaks secret scanning |
          | **ðŸ“‹ Structure** | $(if ($structureOk) { 'âœ… Valid' } else { 'âŒ Invalid' }) | action.yml validation |
          | **ðŸ“ Schema** | $(if ($schemaOk) { 'âœ… Passed' } else { 'âš ï¸ Skipped' }) | Action schema check |
          | **ðŸŽ¨ Linting** | $(if ($lintOk) { 'âœ… Clean' } else { 'âš ï¸ Issues' }) | $scriptsAnalyzed scripts, $totalErrors errors |
          
          ### ðŸŽ¯ Action Details
          | Property | Value |
          |----------|-------|
          | **Name** | ``$actionName`` |
          | **Type** | ``$actionType`` |
          | **Warnings** | ``$totalWarnings`` |
          | **Overall** | $overallStatus |
          
          ---
          "@
          
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“¦ JOB 2: PREPARE RELEASE - Version Detection & Changelog
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare-release:
    name: ðŸ“¦ Prepare Release
    needs: quality-gate
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && needs.quality-gate.outputs.quality-success == 'true'
    outputs:
      new-version: ${{ steps.determine-version.outputs.final-version }}
      should-release: ${{ steps.determine-version.outputs.should-release }}
      bump-type: ${{ steps.determine-version.outputs.bump-type }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â¬†ï¸ Analyze next version
        id: version
        uses: GrexyLoco/K.Actions.NextActionVersion@master
        with:
          branchName: ${{ github.ref_name }}

      - name: ðŸ”¢ Determine final version
        id: determine-version
        shell: pwsh
        run: |
          ./.github/scripts/Determine-Version.ps1 `
            -ManualVersion '${{ github.event.inputs.version }}' `
            -AutoBumpType '${{ steps.version.outputs.bumpType }}' `
            -AutoNewVersion '${{ steps.version.outputs.newVersion }}' `
            -ForceRelease '${{ github.event.inputs.force-release }}'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ“‹ Prepare Release Summary
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“‹ Prepare Release Summary
        if: always()
        shell: pwsh
        run: |
          $shouldRelease = '${{ steps.determine-version.outputs.should-release }}'
          $version = '${{ steps.determine-version.outputs.final-version }}'
          $bumpType = '${{ steps.determine-version.outputs.bump-type }}'
          $currentVersion = '${{ steps.version.outputs.currentVersion }}'
          
          # Determine status icon
          $statusIcon = if ($shouldRelease -eq 'true') { 'âœ… Ready' } else { 'â„¹ï¸ No Release' }
          
          $summary = @"
          ## ðŸ“¦ Prepare Release
          
          | Property | Value |
          |----------|-------|
          | **Current Version** | ``$currentVersion`` |
          | **New Version** | ``$version`` |
          | **Bump Type** | ``$bumpType`` |
          | **Status** | $statusIcon |
          
          "@
          
          if ($shouldRelease -ne 'true') {
            $summary += "`n### â„¹ï¸ No Release Required`n`nNo semantic version changes detected since last tag.`nUse manual workflow dispatch with ``force-release`` to create a release anyway.`n"
          }
          
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸš€ JOB 3: GITHUB RELEASE - Tag, Release, Publish
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  github-release:
    name: ðŸš€ GitHub Release
    needs: [quality-gate, prepare-release]
    if: needs.prepare-release.outputs.should-release == 'true'
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    outputs:
      release-created: ${{ steps.create-release.outputs.release-created }}
      release-tag: ${{ steps.create-release.outputs.release-tag }}
      release-url: ${{ steps.create-release.outputs.release-url }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ“¦ Create Draft Release (Template Pattern)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“¦ Create GitHub Release (Draft)
        id: create-release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./.github/scripts/Create-GitHubRelease.ps1 `
            -Version '${{ needs.prepare-release.outputs.new-version }}' `
            -BumpType '${{ needs.prepare-release.outputs.bump-type }}' `
            -ActionName '${{ env.ACTION_NAME }}' `
            -Repository '${{ github.repository }}'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ·ï¸ Create Smart Tags (v1, v1.2, latest)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ·ï¸ Create Smart Tags
        if: steps.create-release.outputs.release-created == 'true'
        shell: pwsh
        run: |
          ./.github/scripts/Create-SmartTags.ps1 `
            -NewVersion '${{ needs.prepare-release.outputs.new-version }}' `
            -BumpType '${{ needs.prepare-release.outputs.bump-type }}' `
            -ReleaseAuthor '${{ env.RELEASE_AUTHOR }}' `
            -ReleaseEmail '${{ env.RELEASE_EMAIL }}'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # âœ… Publish Release
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœ… Publish GitHub Release
        if: steps.create-release.outputs.release-created == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="${{ steps.create-release.outputs.release-tag }}"
          VERSION="${{ needs.prepare-release.outputs.new-version }}"
          
          # Determine if prerelease
          if [[ "$VERSION" =~ (alpha|beta|rc|preview|pre) ]]; then
            echo "ðŸ§ª Publishing prerelease..."
            gh release edit "$RELEASE_TAG" --draft=false
          else
            echo "ðŸš€ Publishing stable release..."
            gh release edit "$RELEASE_TAG" --draft=false --latest
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ“‹ Release Summary with Usage Example
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“‹ Release Summary
        if: always()
        shell: pwsh
        run: |
          $version = '${{ needs.prepare-release.outputs.new-version }}'
          $releaseUrl = '${{ steps.create-release.outputs.release-url }}'
          $releaseCreated = '${{ steps.create-release.outputs.release-created }}'
          $actionName = '${{ env.ACTION_NAME }}'
          $repository = '${{ github.repository }}'
          
          # Determine release status
          $statusIcon = if ($releaseCreated -eq 'true') { 'âœ… Published' } else { 'âŒ Failed' }
          $majorVersion = $version.Split('.')[0]
          
          $summary = @"
          ## ðŸš€ GitHub Release
          
          | Property | Value |
          |----------|-------|
          | **Version** | ``v$version`` |
          | **Tag** | ``v$version`` |
          | **Status** | $statusIcon |
          | **Release** | [$releaseUrl]($releaseUrl) |
          
          ### ðŸ“– Usage Example
          
          ``````yaml
          - name: Validate PowerShell Module
            uses: $repository@v$version
            with:
              modulePath: './MyModule'
          ``````
          
          ### ðŸ”— Quick Reference
          
          | Reference | Usage |
          |-----------|-------|
          | **Latest** | ``$repository@master`` |
          | **Pinned** | ``$repository@v$version`` |
          | **Major** | ``$repository@v$majorVersion`` |
          "@
          
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY
