name: ðŸš€ Action Release Pipeline

# ðŸŽ¯ Triggers
# - Push to master/main branches (excluding docs)
# - Manual dispatch with release options
on:
  push:
    branches: [master, main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'ðŸ“Œ Override version (e.g., 1.2.3, leave empty for auto-detection)'
        required: false
        type: string
        default: ''
      force-release:
        description: 'ðŸ”„ Force release even if no changes'
        required: false
        default: false
        type: boolean

# Global permissions for the workflow
permissions:
  contents: write
  actions: read
  pull-requests: read

env:
  RELEASE_AUTHOR: "github-actions[bot]"
  RELEASE_EMAIL: "github-actions[bot]@users.noreply.github.com"
  UBUNTU_VERSION: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
  ACTION_NAME: "K.Actions.PSModuleValidation"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ” JOB 1: QUALITY GATE - Security, Structure & Code Quality
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality-gate:
    name: ðŸ” Quality Gate
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    outputs:
      quality-success: ${{ steps.evaluate.outputs.quality-success }}
      action-name: ${{ steps.validate-structure.outputs.action-name }}
      action-type: ${{ steps.validate-structure.outputs.action-type }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” GitLeaks Security Scan
        uses: zricethezav/gitleaks-action@v2.3.9
        continue-on-error: true
        id: gitleaks

      - name: ðŸ“‹ Validate Action Structure
        id: validate-structure
        shell: pwsh
        run: ./.github/scripts/Test-ActionStructure.ps1

      - name: ðŸŽ¨ Lint PowerShell Scripts
        id: lint
        shell: pwsh
        run: ./.github/scripts/Invoke-ScriptAnalyzer.ps1

      - name: ðŸ“Š Evaluate Quality Gate
        id: evaluate
        shell: pwsh
        run: |
          ./.github/scripts/Invoke-QualityGateEvaluation.ps1 `
            -GitLeaksOutcome '${{ steps.gitleaks.outcome }}' `
            -StructureSuccess '${{ steps.validate-structure.outputs.structure-success }}' `
            -SchemaSuccess '${{ steps.validate-structure.outputs.schema-success }}' `
            -LintSuccess '${{ steps.lint.outputs.analysis-success }}' `
            -ActionName '${{ steps.validate-structure.outputs.action-name }}' `
            -ActionType '${{ steps.validate-structure.outputs.action-type }}' `
            -ScriptsAnalyzed '${{ steps.lint.outputs.scripts-analyzed }}' `
            -TotalErrors '${{ steps.lint.outputs.total-errors }}' `
            -TotalWarnings '${{ steps.lint.outputs.total-warnings }}'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ“Š Quality Gate Summary
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“‹ Quality Gate Summary
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          ## ðŸ” Quality Gate Results

          | Check | Status | Details |
          |-------|--------|---------|
          | **Security (GitLeaks)** | ${{ steps.gitleaks.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Issues' }} | Secret scanning |
          | **Action Structure** | ${{ steps.validate-structure.outputs.structure-success == 'true' && 'âœ… Valid' || 'âŒ Invalid' }} | action.yml validation |
          | **Schema Validation** | ${{ steps.validate-structure.outputs.schema-success == 'true' && 'âœ… Passed' || 'âš ï¸ Skipped' }} | Action schema check |
          | **PowerShell Linting** | ${{ steps.lint.outputs.analysis-success == 'true' && 'âœ… Clean' || 'âš ï¸ Issues' }} | ${{ steps.lint.outputs.scripts-analyzed }} scripts, ${{ steps.lint.outputs.total-errors }} errors |

          **Action:** ``${{ steps.validate-structure.outputs.action-name }}`` (${{ steps.validate-structure.outputs.action-type }})
          **Quality Gate:** ${{ steps.evaluate.outputs.quality-success == 'true' && 'âœ… **PASSED**' || 'âŒ **FAILED**' }}
          "@
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“¦ JOB 2: PREPARE RELEASE - Version Detection & Changelog
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare-release:
    name: ðŸ“¦ Prepare Release
    needs: quality-gate
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && needs.quality-gate.outputs.quality-success == 'true'
    outputs:
      new-version: ${{ steps.determine-version.outputs.final-version }}
      should-release: ${{ steps.determine-version.outputs.should-release }}
      changelog: ${{ steps.changelog.outputs.changelog }}
      bump-type: ${{ steps.determine-version.outputs.bump-type }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â¬†ï¸ Analyze next version
        id: version
        uses: GrexyLoco/K.Actions.NextActionVersion@master
        with:
          branchName: ${{ github.ref_name }}

      - name: ðŸ”¢ Determine final version
        id: determine-version
        shell: pwsh
        run: |
          ./.github/scripts/Determine-ReleaseVersion.ps1 `
            -AutoBumpType '${{ steps.version.outputs.bumpType }}' `
            -AutoNewVersion '${{ steps.version.outputs.newVersion }}' `
            -ForceRelease '${{ github.event.inputs.force-release }}'

      - name: ðŸ“ Generate Changelog
        id: changelog
        if: steps.determine-version.outputs.should-release == 'true'
        shell: pwsh
        run: ./.github/scripts/Generate-Changelog.ps1 -Version '${{ steps.determine-version.outputs.final-version }}'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ“‹ Prepare Release Summary
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“‹ Prepare Release Summary
        if: always()
        shell: pwsh
        run: |
          $shouldRelease = '${{ steps.determine-version.outputs.should-release }}'
          $version = '${{ steps.determine-version.outputs.final-version }}'
          $bumpType = '${{ steps.determine-version.outputs.bump-type }}'
          $currentVersion = '${{ steps.version.outputs.currentVersion }}'
          
          $summary = "## ðŸ“¦ Prepare Release`n`n"
          
          if ($shouldRelease -eq 'true') {
            $summary += "| Property | Value |`n"
            $summary += "|----------|-------|`n"
            $summary += "| **Current Version** | ``$currentVersion`` |`n"
            $summary += "| **New Version** | ``$version`` |`n"
            $summary += "| **Bump Type** | ``$bumpType`` |`n"
            $summary += "| **Status** | âœ… Ready for GitHub Release |`n"
          } else {
            $summary += "### â„¹ï¸ No Release Required`n`n"
            $summary += "No semantic version changes detected since last tag.`n"
            $summary += "Use manual workflow dispatch with ``force-release`` to create a release anyway.`n"
          }
          
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸš€ JOB 3: GITHUB RELEASE - Tag, Release, Publish
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  github-release:
    name: ðŸš€ GitHub Release
    needs: [quality-gate, prepare-release]
    if: needs.prepare-release.outputs.should-release == 'true'
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-24.04' }}
    outputs:
      release-created: ${{ steps.create-release.outputs.release-created }}
      release-tag: ${{ steps.create-release.outputs.release-tag }}
      release-url: ${{ steps.create-release.outputs.release-url }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Create Release Tag
        shell: pwsh
        run: |
          ./.github/scripts/Create-ReleaseTag.ps1 `
            -Version '${{ needs.prepare-release.outputs.new-version }}' `
            -ReleaseAuthor '${{ env.RELEASE_AUTHOR }}' `
            -ReleaseEmail '${{ env.RELEASE_EMAIL }}'

      - name: ðŸ“¦ Create GitHub Release
        id: create-release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $changelog = @'
          ${{ needs.prepare-release.outputs.changelog }}
          '@
          
          ./.github/scripts/Create-GitHubRelease.ps1 `
            -Version '${{ needs.prepare-release.outputs.new-version }}' `
            -Changelog $changelog

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ“‹ Release Summary with Usage Example
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“‹ Release Summary
        if: always()
        shell: pwsh
        run: |
          $version = '${{ needs.prepare-release.outputs.new-version }}'
          $releaseUrl = '${{ steps.create-release.outputs.release-url }}'
          $actionName = '${{ env.ACTION_NAME }}'
          
          $summary = @"
          ## ðŸš€ GitHub Release Created

          | Property | Value |
          |----------|-------|
          | **Version** | ``v$version`` |
          | **Tag** | ``v$version`` |
          | **Release URL** | [$releaseUrl]($releaseUrl) |

          ### ðŸ“– Usage Example

          ``````yaml
          - name: Validate PowerShell Module
            uses: GrexyLoco/$actionName@v$version
            with:
              modulePath: './MyModule'
          ``````

          ### ðŸ”— Quick Reference

          | Reference | Usage |
          |-----------|-------|
          | **Latest** | ``GrexyLoco/$actionName@master`` |
          | **Pinned** | ``GrexyLoco/$actionName@v$version`` |
          | **Major** | ``GrexyLoco/$actionName@v$($version.Split('.')[0])`` |
          "@
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY
