name: ðŸ§ª Action Release Test Suite

on:
  # Only triggered manually or by other workflows
  workflow_dispatch:
    inputs:
      test-scope:
        description: 'Scope of tests to run'
        required: false
        default: 'full'
        type: choice
        options:
        - 'full'
        - 'security-only'
        - 'integration-only'
        - 'cross-platform-only'
  workflow_call:
    inputs:
      test-scope:
        description: 'Scope of tests to run'
        required: false
        default: 'full'
        type: string
    outputs:
      test-success:
        description: 'Whether all tests passed'
        value: ${{ jobs.quality-gate.outputs.quality-success == 'true' && jobs.integration-test.outputs.integration-success == 'true' && jobs.cross-platform-test.outputs.cross-platform-success == 'true' }}
      security-success:
        description: 'Whether security scans passed'
        value: ${{ jobs.quality-gate.outputs.quality-success }}
      integration-success:
        description: 'Whether integration tests passed'
        value: ${{ jobs.integration-test.outputs.integration-success }}
      cross-platform-success:
        description: 'Whether cross-platform tests passed'
        value: ${{ jobs.cross-platform-test.outputs.cross-platform-success }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ” JOB 1: QUALITY GATE - Security, Structure & Code Quality
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality-gate:
    name: ðŸ” Quality Gate
    runs-on: ubuntu-latest
    if: inputs.test-scope == 'full' || inputs.test-scope == 'security-only'
    outputs:
      quality-success: ${{ steps.evaluate-quality.outputs.quality-success }}
      action-name: ${{ steps.validate-structure.outputs.action-name }}
      action-type: ${{ steps.validate-structure.outputs.action-type }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ” Security Scanning
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” GitLeaks Security Scan
        uses: zricethezav/gitleaks-action@v2.3.9
        continue-on-error: true
        id: gitleaks

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ“‹ Action Definition Validation
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“‹ Validate Action Structure & Schema
        id: validate-structure
        shell: pwsh
        run: ./.github/scripts/Test-ActionStructure.ps1

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸŽ¨ PowerShell Script Linting (Action-specific only)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸŽ¨ Lint PowerShell Scripts
        id: lint-scripts
        shell: pwsh
        run: ./.github/scripts/Invoke-ScriptAnalyzer.ps1

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ“Š Evaluate Overall Quality Gate
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“Š Evaluate Quality Results
        id: evaluate-quality
        shell: pwsh
        run: |
          $gitleaksOutcome = '${{ steps.gitleaks.outcome }}'
          $structureSuccess = '${{ steps.validate-structure.outputs.structure-success }}'
          $schemaSuccess = '${{ steps.validate-structure.outputs.schema-success }}'
          $lintSuccess = '${{ steps.lint-scripts.outputs.analysis-success }}'
          $actionName = '${{ steps.validate-structure.outputs.action-name }}'
          $actionType = '${{ steps.validate-structure.outputs.action-type }}'
          
          Write-Output "ðŸ” Quality Gate evaluation for: $actionName ($actionType)"
          Write-Output "  ðŸ” GitLeaks: $gitleaksOutcome"
          Write-Output "  ðŸ“‹ Structure: $structureSuccess"
          Write-Output "  ðŸ“‹ Schema: $schemaSuccess"
          Write-Output "  ðŸŽ¨ Linting: $lintSuccess"
          
          # Quality success: All checks must pass
          $qualitySuccess = ($gitleaksOutcome -ne 'failure') -and `
                           ($structureSuccess -eq 'True') -and `
                           ($schemaSuccess -eq 'True') -and `
                           ($lintSuccess -eq 'True')
          
          "quality-success=$qualitySuccess" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          
          if ($qualitySuccess) {
              Write-Output "âœ… Quality Gate passed!"
          } else {
              Write-Output "âŒ Quality Gate failed!"
              exit 1
          }

  cross-platform-test:
    name: ðŸ–¥ï¸ Cross-Platform Compatibility
    runs-on: ${{ matrix.os }}
    needs: quality-gate
    if: always() && (inputs.test-scope == 'full' || inputs.test-scope == 'cross-platform-only') && (needs.quality-gate.result == 'success' || inputs.test-scope == 'cross-platform-only')
    outputs:
      cross-platform-success: ${{ steps.platform-test.outputs.success }}
    strategy:
      matrix:
        os: [ubuntu-22.04, windows-2022]
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ§ª Platform Compatibility Test
        id: platform-test
        shell: bash
        run: |
          echo "ï¿½ï¸ Testing ${{ matrix.os }} compatibility..."
          
          # Detect PowerShell
          if command -v pwsh >/dev/null 2>&1; then
            PS_CMD="pwsh"
            PS_VER=$(pwsh -c '$PSVersionTable.PSVersion.ToString()')
          elif command -v powershell >/dev/null 2>&1; then
            PS_CMD="powershell"
            PS_VER=$(powershell -c '$PSVersionTable.PSVersion.ToString()')
          else
            echo "âŒ No PowerShell found"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… PowerShell: $PS_CMD $PS_VER"
          
          # Run compatibility tests
          $PS_CMD -c '
            $tests = @("Action YAML parsing", "File operations", "Environment access")
            $results = @()
            
            # Test 1: Action parsing
            try {
              $actionContent = Get-Content "./action.yml" -Raw
              $actionName = $actionContent -replace "(?s).*name:\s*['"'"'\""]?([^'"'"'\""]+).*", "$1"
              $results += "âœ… $($tests[0]): $actionName"
              $test1 = $true
            } catch {
              $results += "âŒ $($tests[0]): Failed"
              $test1 = $false
            }
            
            # Test 2: File operations
            try {
              $testFile = "test-$([System.Guid]::NewGuid().ToString().Substring(0,6)).tmp"
              "test" | Out-File $testFile -Encoding UTF8
              $null = Get-Content $testFile
              Remove-Item $testFile -Force
              $results += "âœ… $($tests[1]): OK"
              $test2 = $true
            } catch {
              $results += "âŒ $($tests[1]): Failed"
              $test2 = $false
            }
            
            # Test 3: Environment
            try {
              $workspace = $env:GITHUB_WORKSPACE
              $runner = $env:RUNNER_OS
              $results += "âœ… $($tests[2]): $runner"
              $test3 = $true
            } catch {
              $results += "âŒ $($tests[2]): Failed"
              $test3 = $false
            }
            
            $results | ForEach-Object { Write-Host $_ }
            $success = $test1 -and $test2 -and $test3
            Write-Output "success=$success" >> $env:GITHUB_OUTPUT
            Write-Output "ps-version='$PS_VER'" >> $env:GITHUB_OUTPUT
          '
          
          echo "ps-command=$PS_CMD" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Platform Summary
        if: always()
        shell: pwsh
        run: |
          $success = '${{ steps.platform-test.outputs.success }}'
          $psCmd = '${{ steps.platform-test.outputs.ps-command }}'
          $psVer = '${{ steps.platform-test.outputs.ps-version }}'
          $icon = if ($success -eq 'true') { 'âœ…' } else { 'âŒ' }
          
          Write-Host "$icon Cross-platform test: ${{ matrix.os }}" -ForegroundColor $(if ($success -eq 'true') { 'Green' } else { 'Red' })
          Write-Host "   PowerShell: $psCmd $psVer" -ForegroundColor Gray
          
          $summary = "## ðŸ–¥ï¸ ${{ matrix.os }} $icon`n**PowerShell:** $psCmd $psVer`n**Status:** $(if ($success -eq 'true') { 'Compatible' } else { 'Issues detected' })"
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY
          
          if ($success -ne 'true') { exit 1 }
